<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BTC Macro Pulse v3.1 — Dual-Model Sentiment Engine</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {
        fontFamily: { mono: ['JetBrains Mono', 'monospace'], sans: ['Inter', 'sans-serif'] },
        colors: {
          terminal: { bg: '#080c14', card: '#0f1724', border: '#1a2540', highlight: '#1e3a5f' },
          bull: { light: '#4ade80', DEFAULT: '#22c55e', dark: '#15803d' },
          bear: { light: '#f87171', DEFAULT: '#ef4444', dark: '#b91c1c' },
          warn: '#f59e0b',
          session: { asia: '#818cf8', europe: '#38bdf8', us: '#f59e0b' }
        }
      }}
    }
  </script>
  <style>
    body { background: #080c14; }
    @keyframes pulse-glow { 0%,100% { opacity:.6 } 50% { opacity:1 } }
    @keyframes fade-in { from { opacity:0;transform:translateY(8px) } to { opacity:1;transform:translateY(0) } }
    .animate-fade-in { animation: fade-in .5s ease-out forwards }
    .card-hover { transition: all .2s ease } .card-hover:hover { background:#162033;border-color:#2a4060;transform:translateY(-1px) }
    .live-dot { animation: pulse-glow 2s ease-in-out infinite }
    .stale-overlay { position:relative } .stale-overlay::after { content:'';position:absolute;inset:0;background:rgba(8,12,20,.4);border-radius:inherit;pointer-events:none }
    ::-webkit-scrollbar { width:6px } ::-webkit-scrollbar-track { background:#0f1724 } ::-webkit-scrollbar-thumb { background:#1a2540;border-radius:3px }
  </style>
</head>
<body class="min-h-screen text-gray-100 antialiased font-sans">
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useCallback, useRef } = React;

// ========================================================
// SESSION ENGINE (unchanged from v2)
// ========================================================
const SESSIONS = {
  asia:   { label: 'Asian Session',    start: 0,    end: 8,    color: '#818cf8' },
  europe: { label: 'European Session', start: 8,    end: 13.5, color: '#38bdf8' },
  us:     { label: 'US Session',       start: 13.5, end: 21,   color: '#f59e0b' },
  trans:  { label: 'Transition',       start: 21,   end: 24,   color: '#6b7280' },
};
const MARKET_HOURS = {
  es_futures: { isFutures: true }, nq_futures: { isFutures: true },
  gold_futures: { isFutures: true }, forex: { isFutures: true },
  vix: { openH: 14.5, closeH: 21.25 }, bonds: { openH: 14.5, closeH: 21 },
  crypto: { alwaysOpen: true },
};

function getCurrentSessionInfo() {
  const now = new Date();
  const utcH = now.getUTCHours() + now.getUTCMinutes() / 60;
  const dow = now.getUTCDay();
  const isWeekend = dow === 0 || dow === 6;
  let session = 'trans';
  for (const [k, s] of Object.entries(SESSIONS)) { if (utcH >= s.start && utcH < s.end) { session = k; break; } }
  const marketsOpen = {};
  for (const [k, m] of Object.entries(MARKET_HOURS)) {
    if (m.alwaysOpen) { marketsOpen[k] = true; continue; }
    if (isWeekend) { marketsOpen[k] = false; continue; }
    if (m.isFutures) { marketsOpen[k] = !(utcH >= 22 && utcH < 23); }
    else { marketsOpen[k] = utcH >= m.openH && utcH < m.closeH; }
  }
  return { session, utcHour: utcH, dayOfWeek: dow, isWeekend, marketsOpen, timestamp: now };
}

function getSessionRelevance(category, sessionInfo) {
  if (category === 'crypto') return 1.0;
  if (sessionInfo.isWeekend) return 0.1;
  const m = { asia: 0.35, europe: 0.55, us: 1.0, trans: 0.4 };
  return m[sessionInfo.session] || 0.3;
}

// ========================================================
// FRESHNESS ENGINE (unchanged from v2)
// ========================================================
function freshness4h(h) { if(h==null)return .5; if(h<.5)return 1; if(h<1)return .85; if(h<2)return .65; if(h<4)return .35; if(h<8)return .15; return .05; }
function freshness24h(h) { if(h==null)return .5; if(h<1)return 1; if(h<4)return .9; if(h<8)return .75; if(h<16)return .55; if(h<24)return .35; return .15; }
function fmtAge(h) { if(h==null)return '?'; if(h<.05)return 'now'; if(h<1)return `${Math.round(h*60)}m`; if(h<24)return `${Math.round(h)}h`; return `${Math.round(h/24)}d`; }

// ========================================================
// API LAYER
// ========================================================
const PROXIES = [
  u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
];
async function fetchProxy(url) {
  for (const p of PROXIES) { try { const r = await fetch(p(url),{signal:AbortSignal.timeout(10000)}); if(r.ok) return JSON.parse(await r.text()); } catch(e){} }
  return null;
}

// Yahoo: fetch 5 days of daily data + extract metadata
async function fetchYahoo(sym) {
  const d = await fetchProxy(`https://query1.finance.yahoo.com/v8/finance/chart/${sym}?interval=1d&range=5d`);
  if (!d?.chart?.result) return null;
  try {
    const r = d.chart.result[0], m = r.meta, q = r.indicators.quote[0];
    const closes = q.close.filter(c => c != null);
    if (closes.length < 2) return null;
    const cur = m.regularMarketPrice || closes[closes.length-1];
    const prev = m.chartPreviousClose || closes[closes.length-2];
    const dailyChg = ((cur - prev) / prev) * 100;
    const mktTime = m.regularMarketTime ? m.regularMarketTime * 1000 : null;
    const ageH = mktTime ? (Date.now() - mktTime) / 3600000 : null;
    // Multi-day trend: avg of last 3 closes vs avg of previous 2
    const recent3 = closes.slice(-3);
    const older2 = closes.slice(0, Math.max(1, closes.length - 3));
    const avgRecent = recent3.reduce((a,b)=>a+b,0) / recent3.length;
    const avgOlder = older2.reduce((a,b)=>a+b,0) / older2.length;
    const multiDayTrend = ((avgRecent - avgOlder) / avgOlder) * 100;
    // Range position in 5d
    const allCloses = closes;
    const hi = Math.max(...allCloses), lo = Math.min(...allCloses);
    const rangePos = hi === lo ? 50 : ((cur - lo) / (hi - lo)) * 100;
    return { price: cur, prevClose: prev, dailyChg, multiDayTrend, rangePos, marketTime: mktTime, ageH, live: true };
  } catch(e) { return null; }
}

// BTC: 7 days hourly for trend, range, and 4h momentum
async function fetchBTC7d() {
  try {
    const r = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=7');
    if (!r.ok) throw 0;
    const d = await r.json();
    const prices = d.prices;
    if (!prices || prices.length < 10) return null;
    const latest = prices[prices.length-1];
    const now = Date.now();

    // 4h change
    const t4 = now - 4*3600000;
    let p4 = prices[0];
    for (const p of prices) { if (Math.abs(p[0]-t4) < Math.abs(p4[0]-t4)) p4 = p; }
    const chg4h = ((latest[1] - p4[1]) / p4[1]) * 100;

    // 24h change
    const t24 = now - 24*3600000;
    let p24 = prices[0];
    for (const p of prices) { if (Math.abs(p[0]-t24) < Math.abs(p24[0]-t24)) p24 = p; }
    const chg24h = ((latest[1] - p24[1]) / p24[1]) * 100;

    // 7d change
    const chg7d = ((latest[1] - prices[0][1]) / prices[0][1]) * 100;

    // 3-day trend: avg of last 72h vs avg of hours 72-168 ago
    const last72h = prices.filter(p => p[0] > now - 72*3600000).map(p => p[1]);
    const prev4d = prices.filter(p => p[0] <= now - 72*3600000).map(p => p[1]);
    const avgRecent = last72h.length ? last72h.reduce((a,b)=>a+b,0)/last72h.length : latest[1];
    const avgOlder = prev4d.length ? prev4d.reduce((a,b)=>a+b,0)/prev4d.length : latest[1];
    const multiDayTrend = ((avgRecent - avgOlder) / avgOlder) * 100;

    // 7d range position
    const allP = prices.map(p => p[1]);
    const hi = Math.max(...allP), lo = Math.min(...allP);
    const rangePos = hi === lo ? 50 : ((latest[1] - lo) / (hi - lo)) * 100;

    // Acceleration: is 4h move faster or slower than what 24h trend would imply?
    const implied4h = chg24h / 6; // what a steady 24h trend would produce in 4h
    const acceleration = chg4h - implied4h; // positive = accelerating up

    // Sparkline (24h)
    const last24 = prices.filter(p => p[0] > now - 24*3600000);
    const spark = last24.filter((_,i) => i % Math.max(1, Math.floor(last24.length/24)) === 0).map(p => p[1]);

    return { price: latest[1], chg4h, chg24h, chg7d, multiDayTrend, rangePos, acceleration, sparkline: spark, live: true, timestamp: latest[0] };
  } catch(e) { return null; }
}

async function fetchBTCBasic() {
  try {
    const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true&include_24hr_vol=true&include_market_cap=true');
    if (!r.ok) throw 0;
    const d = await r.json();
    return { price: d.bitcoin.usd, change24h: d.bitcoin.usd_24h_change, volume: d.bitcoin.usd_24h_vol, marketCap: d.bitcoin.usd_market_cap, live: true };
  } catch(e) { return null; }
}

async function fetchETHBTC() {
  try {
    const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=btc,usd&include_24hr_change=true');
    if (!r.ok) throw 0;
    const d = await r.json();
    return { priceBtc: d.ethereum.btc, priceUsd: d.ethereum.usd, change24h: d.ethereum.btc_24h_change || 0, live: true };
  } catch(e) { return null; }
}

async function fetchFearGreed() {
  try {
    const r = await fetch('https://api.alternative.me/fng/?limit=2');
    if (!r.ok) throw 0;
    const d = await r.json();
    const today = d.data[0], yesterday = d.data[1];
    return { value: parseInt(today.value), label: today.value_classification, prevValue: yesterday ? parseInt(yesterday.value) : null, live: true };
  } catch(e) { return null; }
}

// Binance: BTC perp funding rate — measures derivatives positioning
async function fetchFundingRate() {
  try {
    // Current funding rate
    const r = await fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=3');
    if (!r.ok) throw 0;
    const d = await r.json();
    if (!d || d.length === 0) return null;
    const latest = d[d.length - 1];
    const rate = parseFloat(latest.fundingRate);
    const annualized = rate * 3 * 365 * 100; // 3 funding periods/day × 365 days × 100 for %
    // Previous rate for trend
    const prev = d.length >= 2 ? parseFloat(d[d.length - 2].fundingRate) : rate;
    const trend = rate - prev; // positive = funding increasing (more long pressure)
    return { rate, annualized, prev, trend, timestamp: latest.fundingTime, live: true };
  } catch(e) { return null; }
}

const YAHOO_SYMS = {
  sp500: 'ES%3DF', nasdaq: 'NQ%3DF', gold: 'GC%3DF',
  dxy: 'DX-Y.NYB', vix: '%5EVIX', tenYear: '%5ETNX',
};

async function fetchAll() {
  const yahooProms = Object.entries(YAHOO_SYMS).map(async ([k,s]) => ({ key: k, data: await fetchYahoo(s) }));
  const [btc7d, btcBasic, ethBtc, fg, funding, ...yResults] = await Promise.allSettled([
    fetchBTC7d(), fetchBTCBasic(), fetchETHBTC(), fetchFearGreed(), fetchFundingRate(), ...yahooProms,
  ]);
  const tradfi = {};
  for (const y of yResults) { if (y.status==='fulfilled' && y.value) tradfi[y.value.key] = y.value.data; }
  return {
    btc7d: btc7d.status==='fulfilled' ? btc7d.value : null,
    btcBasic: btcBasic.status==='fulfilled' ? btcBasic.value : null,
    ethBtc: ethBtc.status==='fulfilled' ? ethBtc.value : null,
    fearGreed: fg.status==='fulfilled' ? fg.value : null,
    funding: funding.status==='fulfilled' ? funding.value : null,
    tradfi,
  };
}

// ========================================================
// DEMO DATA
// ========================================================
function demoData() {
  const n = Date.now();
  return {
    btc7d: { price:97425, chg4h:0.82, chg24h:2.14, chg7d:5.3, multiDayTrend:2.1, rangePos:72, acceleration:0.46, sparkline:[95200,95800,96100,96300,96800,97100,96900,97200,97425], live:false, timestamp:n },
    btcBasic: { price:97425, change24h:2.14, volume:38200000000, marketCap:1920000000000, live:false },
    ethBtc: { priceBtc:0.0271, priceUsd:2638, change24h:-0.45, live:false },
    funding: { rate:0.00012, annualized:13.14, prev:0.00010, trend:0.00002, timestamp:Date.now(), live:false },
    fearGreed: { value:72, label:'Greed', prevValue:68, live:false },
    tradfi: {
      sp500:  { price:6115.80, prevClose:6078.73, dailyChg:0.61, multiDayTrend:1.2, rangePos:78, marketTime:n-7200000, ageH:2, live:false },
      nasdaq: { price:21890.50, prevClose:21747.30, dailyChg:0.66, multiDayTrend:1.5, rangePos:81, marketTime:n-7200000, ageH:2, live:false },
      gold:   { price:2940.20, prevClose:2935.40, dailyChg:0.16, multiDayTrend:0.8, rangePos:65, marketTime:n-3600000, ageH:1, live:false },
      dxy:    { price:106.55, prevClose:106.82, dailyChg:-0.25, multiDayTrend:-0.4, rangePos:35, marketTime:n-3600000, ageH:1, live:false },
      vix:    { price:15.42, prevClose:15.24, dailyChg:1.18, multiDayTrend:-2.1, rangePos:30, marketTime:n-14400000, ageH:4, live:false },
      tenYear:{ price:4.51, prevClose:4.48, dailyChg:0.67, multiDayTrend:0.3, rangePos:60, marketTime:n-14400000, ageH:4, live:false },
    },
  };
}

// ========================================================
// v3 SCORING ENGINE — Two fundamentally different models
// ========================================================
// Normalise a value to -100..+100 given a typical range
const norm = (v, range) => Math.max(-100, Math.min(100, (v / range) * 50));

// ---- 4-HOUR MODEL: "Tactical Momentum" ----
// Asks: what is the SHORT-TERM flow direction right now?
// Uses: recent changes, acceleration, momentum
function derive4hSignals(data, session) {
  const { btc7d, btcBasic, ethBtc, fearGreed, tradfi } = data;
  const btc = btc7d || btcBasic;
  const signals = [];
  const sesRel = getSessionRelevance('crypto', session);
  const tradRel = getSessionRelevance('tradfi', session);

  // 1. BTC 4h momentum — THE dominant signal for short-term
  const chg4h = btc7d?.chg4h ?? (btcBasic?.change24h ? btcBasic.change24h / 6 : 0);
  signals.push({
    key: 'btc_4h_mom', label: 'BTC 4h Momentum', category: 'crypto',
    raw: chg4h, display: `${chg4h>=0?'+':''}${chg4h.toFixed(2)}%`,
    score: norm(chg4h, 2.0), weight: 0.18,
    freshness: 1.0, relevance: sesRel,
  });

  // 2. BTC acceleration — is the move speeding up or fading?
  const accel = btc7d?.acceleration ?? 0;
  signals.push({
    key: 'btc_accel', label: 'BTC Acceleration', category: 'crypto',
    raw: accel, display: accel >= 0 ? 'Accelerating' : 'Decelerating',
    score: norm(accel, 1.5), weight: 0.10,
    freshness: 1.0, relevance: sesRel,
  });

  // 3. BTC range position as momentum — near highs = continuation, near lows = selling pressure
  // For 4h: interpret as mean-reversion risk at extremes
  const rp = btc7d?.rangePos ?? 50;
  const rpScore4h = rp > 85 ? -15 : rp > 60 ? norm(rp - 50, 40) : rp > 40 ? 0 : rp > 15 ? norm(rp - 50, 40) : 15;
  signals.push({
    key: 'btc_range_4h', label: 'BTC Range Position', category: 'crypto',
    raw: rp, display: `${rp.toFixed(0)}% of 7d range`,
    score: rpScore4h, weight: 0.06,
    freshness: 1.0, relevance: sesRel,
  });

  // 4-7. TradFi MOMENTUM signals (daily change, weighted by freshness)
  const tradfiConf = [
    { key: 'sp500', label: 'S&P 500 Futures', w: 0.10, inv: false, range: 1.0, mkt: 'es_futures' },
    { key: 'nasdaq', label: 'Nasdaq Futures', w: 0.04, inv: false, range: 1.3, mkt: 'nq_futures' },
    { key: 'dxy', label: 'DXY (Dollar)', w: 0.07, inv: true, range: 0.4, mkt: 'forex' },
    { key: 'gold', label: 'Gold Futures', w: 0.06, inv: false, range: 0.8, mkt: 'gold_futures' },
  ];
  for (const c of tradfiConf) {
    const d = tradfi[c.key];
    if (!d) { signals.push({ key: c.key+'_4h', label: c.label, category:'tradfi', missing: true, weight: c.w }); continue; }
    let s = norm(d.dailyChg, c.range);
    if (c.inv) s = -s;
    signals.push({
      key: c.key+'_4h', label: c.label, category: 'tradfi',
      raw: d.dailyChg, display: `${d.dailyChg>=0?'+':''}${d.dailyChg.toFixed(2)}%`, price: d.price,
      score: s, weight: c.w,
      freshness: freshness4h(d.ageH), relevance: tradRel, ageH: d.ageH, live: d.live,
    });
  }

  // 8. VIX change direction — for 4h, we care if fear is RISING or FALLING
  const vd = tradfi.vix;
  if (vd) {
    const vixChgScore = norm(-vd.dailyChg, 5.0); // VIX up = bearish, so invert
    signals.push({
      key: 'vix_4h', label: 'VIX Direction', category: 'tradfi',
      raw: vd.dailyChg, display: `${vd.dailyChg>=0?'+':''}${vd.dailyChg.toFixed(2)}% (${vd.price.toFixed(1)})`, price: vd.price,
      score: vixChgScore, weight: 0.08,
      freshness: freshness4h(vd.ageH), relevance: tradRel, ageH: vd.ageH, live: vd.live,
    });
  } else {
    signals.push({ key: 'vix_4h', label: 'VIX Direction', category:'tradfi', missing: true, weight: 0.08 });
  }

  // 9. ETH/BTC — crypto risk appetite
  if (ethBtc) {
    signals.push({
      key: 'ethbtc_4h', label: 'ETH/BTC Flow', category: 'crypto',
      raw: ethBtc.change24h, display: `${ethBtc.change24h>=0?'+':''}${ethBtc.change24h.toFixed(2)}%`,
      score: norm(ethBtc.change24h, 2.0), weight: 0.08,
      freshness: 1.0, relevance: sesRel, price: ethBtc.priceBtc, live: ethBtc.live,
    });
  } else {
    signals.push({ key: 'ethbtc_4h', label: 'ETH/BTC Flow', category:'crypto', missing: true, weight: 0.08 });
  }

  // 10. Fear & Greed change direction — is sentiment shifting?
  if (fearGreed && fearGreed.prevValue != null) {
    const fgChg = fearGreed.value - fearGreed.prevValue;
    signals.push({
      key: 'fg_4h', label: 'Sentiment Shift', category: 'crypto',
      raw: fgChg, display: `${fgChg>=0?'+':''}${fgChg} (${fearGreed.value} ${fearGreed.label})`,
      score: norm(fgChg, 10), weight: 0.05,
      freshness: 0.8, relevance: sesRel, live: fearGreed.live,
    });
  } else {
    signals.push({ key: 'fg_4h', label: 'Sentiment Shift', category:'crypto', missing: !fearGreed, weight: 0.05,
      raw: fearGreed?.value, display: fearGreed ? `${fearGreed.value} ${fearGreed.label}` : '—',
      score: fearGreed ? (fearGreed.value - 50) * 0.8 : 0, freshness: 0.8, relevance: sesRel, live: fearGreed?.live,
    });
  }

  // 11. Funding Rate — CONTRARIAN signal for 4h
  // Extreme positive funding = overleveraged longs = bearish pressure (contrarian)
  // Extreme negative funding = overleveraged shorts = bullish pressure (squeeze risk)
  // Moderate funding = neutral, follow the trend
  const { funding } = data;
  if (funding) {
    const ann = funding.annualized;
    // Contrarian: high positive funding → bearish, negative funding → bullish
    // Use non-linear mapping: moderate funding (5-15% ann) is normal and near-neutral
    // Only extreme levels produce strong signals
    let fScore;
    if (ann > 50) fScore = -80;       // extreme longs, very bearish contrarian
    else if (ann > 30) fScore = -55;
    else if (ann > 15) fScore = -25;
    else if (ann > 5) fScore = -8;     // slightly elevated, minor headwind
    else if (ann > -5) fScore = 0;     // neutral range
    else if (ann > -15) fScore = 10;
    else if (ann > -30) fScore = 35;
    else fScore = 65;                  // extreme shorts, strong squeeze potential

    // Trend modifier: if funding is INCREASING, contrarian pressure builds faster
    const trendMod = funding.trend > 0 ? -norm(funding.trend * 100000, 3) * 0.15 : -norm(funding.trend * 100000, 3) * 0.15;
    fScore = Math.max(-100, Math.min(100, fScore + trendMod));

    signals.push({
      key: 'funding_4h', label: 'Funding Rate', category: 'crypto',
      raw: funding.rate, display: `${(funding.rate*100).toFixed(4)}% (${ann>=0?'+':''}${ann.toFixed(0)}% ann.)`,
      score: fScore, weight: 0.18,
      freshness: 1.0, relevance: sesRel, live: funding.live,
    });
  } else {
    signals.push({ key: 'funding_4h', label: 'Funding Rate', category:'crypto', missing: true, weight: 0.18 });
  }

  return signals;
}

// ---- 24-HOUR MODEL: "Macro Regime" ----
// Asks: what is the BROADER ENVIRONMENT and direction?
// Uses: levels, multi-day trends, regime indicators, range position
function derive24hSignals(data, session) {
  const { btc7d, btcBasic, ethBtc, fearGreed, tradfi } = data;
  const btc = btc7d || btcBasic;
  const signals = [];
  const sesRel = getSessionRelevance('crypto', session);
  const tradRel = getSessionRelevance('tradfi', session);

  // 1. BTC 24h momentum — moderate weight, this is background context
  const chg24h = btc7d?.chg24h ?? btcBasic?.change24h ?? 0;
  signals.push({
    key: 'btc_24h_mom', label: 'BTC 24h Change', category: 'crypto',
    raw: chg24h, display: `${chg24h>=0?'+':''}${chg24h.toFixed(2)}%`,
    score: norm(chg24h, 4.0), weight: 0.08,
    freshness: 1.0, relevance: sesRel,
  });

  // 2. BTC multi-day trend direction — is the 3-day trend up or down?
  const trend = btc7d?.multiDayTrend ?? 0;
  signals.push({
    key: 'btc_trend', label: 'BTC Multi-Day Trend', category: 'crypto',
    raw: trend, display: trend > 0.5 ? 'Uptrend' : trend < -0.5 ? 'Downtrend' : 'Flat',
    score: norm(trend, 3.0), weight: 0.12,
    freshness: 1.0, relevance: sesRel,
  });

  // 3. BTC 7d range position — for 24h, high = trend strength, low = trend weakness
  const rp = btc7d?.rangePos ?? 50;
  const rpScore24h = norm(rp - 50, 50); // linear: 100→+50, 50→0, 0→-50
  signals.push({
    key: 'btc_range_24h', label: 'BTC Range Position', category: 'crypto',
    raw: rp, display: `${rp.toFixed(0)}% of 7d range`,
    score: rpScore24h, weight: 0.06,
    freshness: 1.0, relevance: sesRel,
  });

  // 4-8. TradFi REGIME signals: daily change + multi-day trend blended
  const tradfiConf = [
    { key: 'sp500', label: 'S&P 500 Regime', w: 0.10, inv: false, range: 1.0, tRange: 1.5 },
    { key: 'nasdaq', label: 'Nasdaq Regime', w: 0.04, inv: false, range: 1.3, tRange: 2.0 },
    { key: 'dxy', label: 'DXY Regime', w: 0.10, inv: true, range: 0.4, tRange: 0.6 },
    { key: 'gold', label: 'Gold Regime', w: 0.06, inv: false, range: 0.8, tRange: 1.2 },
    { key: 'tenYear', label: '10Y Yield Regime', w: 0.06, inv: true, range: 2.0, tRange: 3.0 },
  ];
  for (const c of tradfiConf) {
    const d = tradfi[c.key];
    if (!d) { signals.push({ key: c.key+'_24h', label: c.label, category:'tradfi', missing: true, weight: c.w }); continue; }
    // Blend: 60% multi-day trend + 40% daily change
    const dailySig = norm(d.dailyChg, c.range);
    const trendSig = norm(d.multiDayTrend, c.tRange);
    let blended = dailySig * 0.4 + trendSig * 0.6;
    if (c.inv) blended = -blended;
    const trendDir = d.multiDayTrend > 0.1 ? 'up' : d.multiDayTrend < -0.1 ? 'down' : 'flat';
    signals.push({
      key: c.key+'_24h', label: c.label, category: 'tradfi',
      raw: d.dailyChg, display: `${d.dailyChg>=0?'+':''}${d.dailyChg.toFixed(2)}% / trend ${trendDir}`, price: d.price,
      score: blended, weight: c.w,
      freshness: freshness24h(d.ageH), relevance: tradRel, ageH: d.ageH, live: d.live,
      trend: d.multiDayTrend, rangePos: d.rangePos,
    });
  }

  // 9. VIX LEVEL regime — for 24h, absolute level matters more than direction
  const vd = tradfi.vix;
  if (vd) {
    const vixLevel = vd.price;
    const vixLevelScore = vixLevel < 13 ? 50 : vixLevel < 16 ? 30 : vixLevel < 20 ? 0 : vixLevel < 25 ? -30 : vixLevel < 30 ? -60 : -85;
    signals.push({
      key: 'vix_24h', label: 'VIX Regime', category: 'tradfi',
      raw: vixLevel, display: `${vixLevel.toFixed(1)} (${vixLevel<16?'Low fear':vixLevel<20?'Normal':vixLevel<25?'Elevated':vixLevel<30?'High fear':'Extreme fear'})`, price: vd.price,
      score: vixLevelScore, weight: 0.10,
      freshness: freshness24h(vd.ageH), relevance: tradRel, ageH: vd.ageH, live: vd.live,
    });
  } else {
    signals.push({ key: 'vix_24h', label: 'VIX Regime', category:'tradfi', missing: true, weight: 0.10 });
  }

  // 10. ETH/BTC trend
  if (ethBtc) {
    signals.push({
      key: 'ethbtc_24h', label: 'ETH/BTC Trend', category: 'crypto',
      raw: ethBtc.change24h, display: `${ethBtc.change24h>=0?'+':''}${ethBtc.change24h.toFixed(2)}%`,
      score: norm(ethBtc.change24h, 2.5), weight: 0.06,
      freshness: 1.0, relevance: sesRel, price: ethBtc.priceBtc, live: ethBtc.live,
    });
  } else {
    signals.push({ key: 'ethbtc_24h', label: 'ETH/BTC Trend', category:'crypto', missing: true, weight: 0.06 });
  }

  // 11. Fear & Greed absolute level — for 24h, the level tells us the regime
  if (fearGreed) {
    signals.push({
      key: 'fg_24h', label: 'Sentiment Regime', category: 'crypto',
      raw: fearGreed.value, display: `${fearGreed.value} — ${fearGreed.label}`,
      score: (fearGreed.value - 50) * 1.2, weight: 0.08,
      freshness: 1.0, relevance: sesRel, live: fearGreed.live,
    });
  } else {
    signals.push({ key: 'fg_24h', label: 'Sentiment Regime', category:'crypto', missing: true, weight: 0.08 });
  }

  // 12. BTC weekly change — broader context
  const chg7d = btc7d?.chg7d ?? 0;
  signals.push({
    key: 'btc_7d', label: 'BTC 7d Change', category: 'crypto',
    raw: chg7d, display: `${chg7d>=0?'+':''}${chg7d.toFixed(2)}%`,
    score: norm(chg7d, 8.0), weight: 0.04,
    freshness: 1.0, relevance: sesRel,
  });

  // 13. Funding Rate — REGIME signal for 24h
  // For macro regime, sustained elevated funding = overheated derivatives market
  // We care about the absolute level and whether it's healthy or dangerous
  const { funding } = data;
  if (funding) {
    const ann = funding.annualized;
    // Level-based regime assessment:
    // Moderate positive (5-15%) = healthy bull market, slightly positive signal
    // High positive (>15%) = getting overheated, bearish warning
    // Negative = short-heavy, contrarian bullish
    let fScore;
    if (ann > 50) fScore = -70;       // dangerously overheated
    else if (ann > 30) fScore = -45;
    else if (ann > 15) fScore = -20;   // elevated, caution
    else if (ann > 5) fScore = 15;     // healthy bullish positioning
    else if (ann > 0) fScore = 10;     // neutral-positive
    else if (ann > -5) fScore = 5;     // neutral
    else if (ann > -15) fScore = 25;   // shorts building, contrarian bullish
    else fScore = 50;                  // extreme shorts, strongly bullish regime

    signals.push({
      key: 'funding_24h', label: 'Funding Regime', category: 'crypto',
      raw: funding.rate, display: `${(funding.rate*100).toFixed(4)}% (${ann>=0?'+':''}${ann.toFixed(0)}% ann.)`,
      score: fScore, weight: 0.10,
      freshness: 1.0, relevance: sesRel, live: funding.live,
    });
  } else {
    signals.push({ key: 'funding_24h', label: 'Funding Regime', category:'crypto', missing: true, weight: 0.10 });
  }

  return signals;
}

// Compute final score from signal array using adaptive weights
function computeAdaptiveScore(signals) {
  let totalEW = 0;
  const items = signals.map(s => {
    if (s.missing) return { ...s, ew: 0, normWeight: 0, contribution: 0 };
    const ew = s.weight * (s.freshness ?? 0.5) * (s.relevance ?? 0.5);
    totalEW += ew;
    return { ...s, ew };
  });
  if (totalEW === 0) return { score: 0, signals: items };
  let score = 0;
  for (const s of items) {
    s.normWeight = s.ew / totalEW;
    s.contribution = s.score * s.normWeight;
    score += s.contribution;
  }
  return { score: Math.round(Math.max(-100, Math.min(100, score))), signals: items };
}

// ========================================================
// DISPLAY HELPERS
// ========================================================
const scoreLabel = s => s>=60?'Strongly Bullish':s>=30?'Bullish':s>=10?'Leaning Bullish':s>=-10?'Neutral':s>=-30?'Leaning Bearish':s>=-60?'Bearish':'Strongly Bearish';
const scoreColor = s => s>=40?'#22c55e':s>=15?'#4ade80':s>=-15?'#f59e0b':s>=-40?'#f87171':'#ef4444';

function generateDivergenceExplain(score4h, score24h, sig4h, sig24h) {
  const diff = score4h - score24h;
  if (Math.abs(diff) < 12) return null;

  if (diff > 0) {
    // 4h more bullish than 24h
    const top4h = sig4h.filter(s => !s.missing).sort((a,b) => b.contribution - a.contribution).slice(0,2);
    return `4h is more bullish than 24h by ${Math.abs(diff)} points. Short-term momentum (${top4h.map(s=>s.label).join(', ')}) is outpacing the broader trend. This often occurs during breakout attempts or relief rallies within a weaker macro backdrop.`;
  } else {
    // 24h more bullish than 4h
    const top24h = sig24h.filter(s => !s.missing).sort((a,b) => b.contribution - a.contribution).slice(0,2);
    return `24h is more bullish than 4h by ${Math.abs(diff)} points. The broader regime (${top24h.map(s=>s.label).join(', ')}) is constructive, but short-term momentum is weak. This often signals an intraday dip within a bullish trend — potentially a buying opportunity if the macro thesis holds.`;
  }
}

function genSummary(score, signals, tf, session) {
  const label = score>=30?'bullish':score>=10?'slightly bullish':score>=-10?'neutral':score>=-30?'slightly bearish':'bearish';
  const tfLabel = tf === '4h' ? 'next 4 hours' : 'next 24 hours';
  const active = signals.filter(s => !s.missing);
  const bull = active.filter(s => s.contribution > 1.5).sort((a,b) => b.contribution - a.contribution).slice(0,3);
  const bear = active.filter(s => s.contribution < -1.5).sort((a,b) => a.contribution - b.contribution).slice(0,2);
  let parts = [`<strong>${label[0].toUpperCase()+label.slice(1)}</strong> for the ${tfLabel}.`];
  if (session.isWeekend) parts.push('Weekend — crypto-native signals dominate.');
  if (bull.length) parts.push(`Drivers: ${bull.map(s=>`${s.label} (${s.display})`).join(', ')}.`);
  if (bear.length) parts.push(`Headwinds: ${bear.map(s=>`${s.label} (${s.display})`).join(', ')}.`);
  const stale = active.filter(s => s.category==='tradfi' && (s.freshness??1) < 0.3);
  if (stale.length && tf==='4h') parts.push(`<span class="text-gray-600">${stale.length} stale TradFi signal(s) — weight shifted to crypto data.</span>`);
  return parts.join(' ');
}

// ========================================================
// COMPONENTS
// ========================================================
function GaugeChart({ score, size=220, id='g' }) {
  const cx=size/2, r=size*.38, sw=size*.055;
  const ang = Math.PI*(100-score)/200;
  const nl=r-sw-6, nx=cx+nl*Math.cos(ang), ny=cx-nl*Math.sin(ang);
  const col = scoreColor(score);
  const arc = (s,e,rr) => { const x1=cx+rr*Math.cos(s),y1=cx-rr*Math.sin(s),x2=cx+rr*Math.cos(e),y2=cx-rr*Math.sin(e); return `M ${x1} ${y1} A ${rr} ${rr} 0 ${e-s>Math.PI?0:1} 0 ${x2} ${y2}`; };
  return (
    <div className="flex items-center justify-center" style={{width:size,height:size*.58}}>
      <svg width={size} height={size*.58} viewBox={`0 0 ${size} ${size*.58}`}>
        <defs>
          <linearGradient id={`gg${id}`} x1="0%" y1="0%" x2="100%"><stop offset="0%" stopColor="#ef4444"/><stop offset="35%" stopColor="#f59e0b"/><stop offset="50%" stopColor="#eab308"/><stop offset="65%" stopColor="#84cc16"/><stop offset="100%" stopColor="#22c55e"/></linearGradient>
          <filter id={`gl${id}`}><feGaussianBlur stdDeviation="2.5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <path d={arc(Math.PI,0,r)} fill="none" stroke="#1a2540" strokeWidth={sw} strokeLinecap="round"/>
        <path d={arc(Math.PI,ang,r)} fill="none" stroke={`url(#gg${id})`} strokeWidth={sw} strokeLinecap="round" filter={`url(#gl${id})`}/>
        {[-100,-50,0,50,100].map(t => { const a=Math.PI*(100-t)/200,o=r+sw/2+3,i=r+sw/2+(t%100===0?12:8); return <line key={t} x1={cx+o*Math.cos(a)} y1={cx-o*Math.sin(a)} x2={cx+i*Math.cos(a)} y2={cx-i*Math.sin(a)} stroke="#374151" strokeWidth={t%100===0?1.5:1}/>; })}
        <text x={cx-r-16} y={cx+12} fill="#4b5563" fontSize="9" fontFamily="JetBrains Mono" textAnchor="middle">-100</text>
        <text x={cx} y={cx-r-10} fill="#4b5563" fontSize="9" fontFamily="JetBrains Mono" textAnchor="middle">0</text>
        <text x={cx+r+16} y={cx+12} fill="#4b5563" fontSize="9" fontFamily="JetBrains Mono" textAnchor="middle">+100</text>
        <line x1={cx} y1={cx} x2={nx} y2={ny} stroke={col} strokeWidth={2} strokeLinecap="round" filter={`url(#gl${id})`}/>
        <circle cx={cx} cy={cx} r={5} fill={col} filter={`url(#gl${id})`}/><circle cx={cx} cy={cx} r={2.5} fill="#080c14"/>
      </svg>
    </div>
  );
}

function Sparkline({ data, color='#f97316', height=28 }) {
  if (!data||data.length<2) return null;
  const mn=Math.min(...data),mx=Math.max(...data),rng=mx-mn||1,w=100;
  const pts=data.map((v,i)=>`${(i/(data.length-1))*w},${height-((v-mn)/rng)*(height-2)-1}`).join(' ');
  return <svg width="100%" height={height} viewBox={`0 0 ${w} ${height}`} preserveAspectRatio="none"><polyline points={pts} fill="none" stroke={color} strokeWidth="1.2" strokeLinejoin="round"/></svg>;
}

function SessionBar({ si }) {
  const {session,utcHour,isWeekend,marketsOpen}=si;
  const pct=(utcHour/24)*100;
  const segs=[{k:'asia',s:0,e:33.33,c:'#818cf8',l:'ASIA'},{k:'europe',s:33.33,e:56.25,c:'#38bdf8',l:'EU'},{k:'us',s:56.25,e:87.5,c:'#f59e0b',l:'US'},{k:'trans',s:87.5,e:100,c:'#6b7280',l:''}];
  const oc=Object.values(marketsOpen).filter(Boolean).length,tc=Object.keys(marketsOpen).length;
  return (
    <div className="bg-terminal-card border border-terminal-border rounded-lg p-4 animate-fade-in">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <span className="text-xs font-mono text-gray-500 uppercase">Session:</span>
          <span className="text-xs font-mono font-semibold" style={{color:SESSIONS[session]?.color||'#6b7280'}}>{isWeekend?'WEEKEND':SESSIONS[session]?.label?.toUpperCase()||'TRANSITION'}</span>
        </div>
        <div className="flex items-center gap-2">
          <span className="text-xs font-mono text-gray-500">{oc}/{tc} mkts open</span>
          <span className="text-[10px] font-mono text-gray-600">{String(Math.floor(utcHour)).padStart(2,'0')}:{String(Math.round((utcHour%1)*60)).padStart(2,'0')} UTC</span>
        </div>
      </div>
      <div className="relative h-3 bg-gray-900 rounded-full overflow-hidden">
        {segs.map(s=><div key={s.k} className="absolute top-0 h-full" style={{left:`${s.s}%`,width:`${s.e-s.s}%`,backgroundColor:s.c,opacity:session===s.k?.6:.15}}/>)}
        <div className="absolute top-0 h-full w-0.5 bg-white live-dot" style={{left:`${pct}%`}}/>
      </div>
      <div className="flex justify-between mt-1.5 text-[9px] font-mono text-gray-600">
        <span>00 UTC</span>{segs.filter(s=>s.l).map(s=><span key={s.k} style={{color:session===s.k?s.c:'#4b5563'}}>{s.l}</span>)}<span>24 UTC</span>
      </div>
    </div>
  );
}

function DualScore({ s4, s24, sum4, sum24, divExplain, loading }) {
  return (
    <div className="animate-fade-in">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="flex flex-col items-center">
          <div className="text-[10px] font-mono uppercase tracking-widest mb-1">
            <span className="text-blue-400">Tactical Momentum</span> <span className="text-gray-600">/ 4 Hours</span>
          </div>
          <GaugeChart score={loading?0:s4} size={240} id="4h"/>
          <div className="text-center -mt-1">
            <div className="font-mono text-4xl font-bold" style={{color:scoreColor(s4)}}>{loading?'—':`${s4>0?'+':''}${s4}`}</div>
            <div className="text-sm font-semibold mt-0.5" style={{color:scoreColor(s4)}}>{loading?'Loading...':scoreLabel(s4)}</div>
          </div>
          {!loading&&sum4&&<div className="mt-3 text-xs text-gray-400 leading-relaxed text-center px-2 max-w-sm" dangerouslySetInnerHTML={{__html:sum4}}/>}
        </div>
        <div className="flex flex-col items-center">
          <div className="text-[10px] font-mono uppercase tracking-widest mb-1">
            <span className="text-purple-400">Macro Regime</span> <span className="text-gray-600">/ 24 Hours</span>
          </div>
          <GaugeChart score={loading?0:s24} size={240} id="24h"/>
          <div className="text-center -mt-1">
            <div className="font-mono text-4xl font-bold" style={{color:scoreColor(s24)}}>{loading?'—':`${s24>0?'+':''}${s24}`}</div>
            <div className="text-sm font-semibold mt-0.5" style={{color:scoreColor(s24)}}>{loading?'Loading...':scoreLabel(s24)}</div>
          </div>
          {!loading&&sum24&&<div className="mt-3 text-xs text-gray-400 leading-relaxed text-center px-2 max-w-sm" dangerouslySetInnerHTML={{__html:sum24}}/>}
        </div>
      </div>
      {!loading && divExplain && (
        <div className="mt-4 px-4 py-3 bg-terminal-highlight/20 border border-terminal-border rounded-lg text-xs text-gray-400 leading-relaxed">
          <span className="font-mono text-gray-500 uppercase text-[10px]">Score Divergence:</span> {divExplain}
        </div>
      )}
    </div>
  );
}

function BTCCard({ btc7d, btcBasic }) {
  const btc = btc7d || btcBasic;
  if (!btc) return null;
  const c4 = btc7d?.chg4h, c24 = btc7d?.chg24h ?? btcBasic?.change24h, c7 = btc7d?.chg7d;
  const cc = v => (v??0)>=0?'text-bull-light':'text-bear-light';
  return (
    <div className="bg-terminal-card border-2 border-orange-900/50 rounded-lg p-4 card-hover animate-fade-in">
      <div className="flex items-center justify-between mb-1">
        <span className="text-xs text-orange-400 font-mono uppercase tracking-wider font-bold">Bitcoin</span>
        <div className={`w-1.5 h-1.5 rounded-full ${btc.live?'bg-green-500 live-dot':'bg-yellow-600'}`}/>
      </div>
      <div className="font-mono text-2xl font-bold text-orange-400">${btc.price?.toLocaleString('en-US',{maximumFractionDigits:0})}</div>
      <div className="flex items-center gap-3 mt-1 flex-wrap">
        {c4!=null&&<span className={`font-mono text-xs ${cc(c4)}`}>{c4>=0?'+':''}{c4.toFixed(2)}% <span className="text-gray-600">4h</span></span>}
        {c24!=null&&<span className={`font-mono text-xs ${cc(c24)}`}>{c24>=0?'+':''}{c24.toFixed(2)}% <span className="text-gray-600">24h</span></span>}
        {c7!=null&&<span className={`font-mono text-xs ${cc(c7)}`}>{c7>=0?'+':''}{c7.toFixed(1)}% <span className="text-gray-600">7d</span></span>}
      </div>
      {btcBasic&&<div className="text-[10px] text-gray-600 mt-1 font-mono">Vol: ${(btcBasic.volume/1e9)?.toFixed(1)}B &middot; MCap: ${(btcBasic.marketCap/1e12)?.toFixed(2)}T</div>}
      {btc7d?.rangePos!=null&&<div className="text-[10px] text-gray-600 mt-0.5 font-mono">7d range: {btc7d.rangePos.toFixed(0)}% &middot; {btc7d.acceleration>=0?'Accelerating':'Decelerating'}</div>}
      {btc7d?.sparkline?.length>3&&<div className="mt-2"><Sparkline data={btc7d.sparkline}/></div>}
    </div>
  );
}

function SignalRow({ s }) {
  if (s.missing) return (
    <tr className="border-b border-terminal-border/30 opacity-30">
      <td className="p-2 font-mono text-gray-500 text-xs">{s.label}</td>
      <td colSpan={4} className="p-2 text-center text-gray-700 text-xs">No data</td>
    </tr>
  );
  const cc = v => v>1.5?'text-bull-light':v<-1.5?'text-bear-light':'text-gray-500';
  const sc = v => v>10?'text-bull-light':v<-10?'text-bear-light':'text-warn';
  return (
    <tr className="border-b border-terminal-border/30 hover:bg-terminal-highlight/10">
      <td className="p-2 font-mono text-gray-300 text-xs">
        <span className={`inline-block w-1.5 h-1.5 rounded-full mr-1.5 ${s.category==='crypto'?'bg-orange-500':'bg-blue-500'}`}/>
        {s.label}
        {s.ageH!=null&&s.ageH>.5&&<span className="text-gray-700 ml-1 text-[9px]">{fmtAge(s.ageH)}</span>}
      </td>
      <td className="p-2 text-right font-mono text-gray-400 text-xs">{s.display||'—'}</td>
      <td className={`p-2 text-right font-mono text-xs ${sc(s.score)}`}>{s.score>0?'+':''}{Math.round(s.score)}</td>
      <td className="p-2 text-right font-mono text-gray-600 text-xs">{((s.normWeight||0)*100).toFixed(0)}%</td>
      <td className={`p-2 text-right font-mono font-semibold text-xs ${cc(s.contribution||0)}`}>{(s.contribution||0)>0?'+':''}{(s.contribution||0).toFixed(1)}</td>
    </tr>
  );
}

function SignalPanel({ title, subtitle, color, signals, score }) {
  const sorted = [...signals].sort((a,b) => Math.abs(b.contribution||0)-Math.abs(a.contribution||0));
  return (
    <div className="animate-fade-in">
      <div className="flex items-baseline gap-2 mb-2">
        <h3 className="text-xs font-mono uppercase tracking-wider" style={{color}}>{title}</h3>
        <span className="text-[10px] font-mono text-gray-600">{subtitle}</span>
      </div>
      <div className="bg-terminal-card border border-terminal-border rounded-lg overflow-x-auto">
        <table className="w-full text-xs">
          <thead><tr className="border-b border-terminal-border">
            <th className="text-left p-2 font-mono text-gray-500 uppercase">Signal</th>
            <th className="text-right p-2 font-mono text-gray-500 uppercase">Value</th>
            <th className="text-right p-2 font-mono text-gray-500 uppercase">Score</th>
            <th className="text-right p-2 font-mono text-gray-500 uppercase">Weight</th>
            <th className="text-right p-2 font-mono text-gray-500 uppercase">Contrib</th>
          </tr></thead>
          <tbody>{sorted.map(s => <SignalRow key={s.key} s={s}/>)}</tbody>
          <tfoot><tr className="bg-terminal-highlight/20">
            <td colSpan={4} className="p-2 font-mono font-semibold text-gray-300">Score</td>
            <td className="p-2 text-right font-mono font-bold text-sm" style={{color:scoreColor(score)}}>{score>0?'+':''}{score}</td>
          </tr></tfoot>
        </table>
      </div>
    </div>
  );
}

function MethodNote() {
  return (
    <div className="bg-terminal-card border border-terminal-border rounded-lg p-4 text-[11px] text-gray-500 leading-relaxed animate-fade-in">
      <h4 className="font-mono uppercase tracking-wider text-gray-400 mb-2 text-xs">Methodology v3.1 — Dual Model + Funding</h4>
      <p className="mb-2">
        v3 uses <strong className="text-blue-400">two fundamentally different scoring models</strong>, not just different weights on the same signals:
      </p>
      <p className="mb-2">
        <strong className="text-blue-400">4h Tactical Momentum</strong> asks "what is the short-term flow direction?" It uses BTC's 4-hour price change (18% weight) and <strong className="text-gray-400">perp funding rate as a contrarian signal</strong> (18% weight — extreme positive funding signals overleveraged longs vulnerable to liquidation). Also includes acceleration, VIX direction, sentiment shift, and mean-reversion-aware range position.
      </p>
      <p className="mb-2">
        <strong className="text-purple-400">24h Macro Regime</strong> asks "what is the broader environment?" It uses BTC's <strong className="text-gray-400">multi-day trend direction</strong> (12% weight), <strong className="text-gray-400">funding rate regime</strong> (10% weight — sustained high funding = overheated market, negative funding = contrarian bullish), blended TradFi trends (60% multi-day / 40% daily), VIX <em>absolute level</em> bands, and Fear & Greed <em>absolute level</em>.
      </p>
      <p>
        The same raw data produces different derived signals for each model. Session relevance and freshness decay still apply as adaptive weight multipliers. When scores diverge significantly, the dashboard explains why — e.g., "short-term pullback within bullish regime."
      </p>
    </div>
  );
}

// ========================================================
// MAIN APP
// ========================================================
function App() {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [lastUpdate, setLastUpdate] = useState(null);
  const [liveCount, setLiveCount] = useState(0);
  const [isDemo, setIsDemo] = useState(false);
  const [error, setError] = useState(null);
  const [si, setSi] = useState(getCurrentSessionInfo());
  const ref1 = useRef(null), ref2 = useRef(null);

  useEffect(() => { ref2.current = setInterval(()=>setSi(getCurrentSessionInfo()), 30000); return ()=>clearInterval(ref2.current); }, []);

  const load = useCallback(async () => {
    setLoading(true); setError(null);
    try {
      const d = await fetchAll();
      let live = 0;
      if(d.btc7d?.live) live++; if(d.btcBasic?.live) live++; if(d.ethBtc?.live) live++; if(d.fearGreed?.live) live++; if(d.funding?.live) live++;
      Object.values(d.tradfi).forEach(m => { if(m?.live) live++; });
      const demo = demoData();
      if (live <= 1) {
        setData({ btc7d:d.btc7d||demo.btc7d, btcBasic:d.btcBasic||demo.btcBasic, ethBtc:d.ethBtc||demo.ethBtc, fearGreed:d.fearGreed||demo.fearGreed, funding:d.funding||demo.funding, tradfi:{...demo.tradfi,...d.tradfi} });
        setIsDemo(live===0);
      } else {
        setData({
          btc7d:d.btc7d||demo.btc7d, btcBasic:d.btcBasic||demo.btcBasic, ethBtc:d.ethBtc||demo.ethBtc, fearGreed:d.fearGreed||demo.fearGreed, funding:d.funding||demo.funding,
          tradfi: Object.fromEntries(Object.keys(YAHOO_SYMS).map(k => [k, d.tradfi[k]||demo.tradfi[k]])),
        });
        setIsDemo(false);
      }
      setLiveCount(live); setLastUpdate(new Date());
    } catch(e) {
      console.error(e); setData(demoData()); setIsDemo(true); setLastUpdate(new Date());
      setError('Using demo data — live APIs unreachable');
    }
    setLoading(false);
  }, []);

  useEffect(() => { load(); ref1.current = setInterval(load, 5*60000); return ()=>clearInterval(ref1.current); }, [load]);

  const sig4h = useMemo(() => data ? derive4hSignals(data, si) : [], [data, si]);
  const sig24h = useMemo(() => data ? derive24hSignals(data, si) : [], [data, si]);
  const res4h = useMemo(() => computeAdaptiveScore(sig4h), [sig4h]);
  const res24h = useMemo(() => computeAdaptiveScore(sig24h), [sig24h]);
  const sum4h = useMemo(() => sig4h.length ? genSummary(res4h.score, res4h.signals, '4h', si) : '', [res4h, si]);
  const sum24h = useMemo(() => sig24h.length ? genSummary(res24h.score, res24h.signals, '24h', si) : '', [res24h, si]);
  const divExplain = useMemo(() => generateDivergenceExplain(res4h.score, res24h.score, res4h.signals, res24h.signals), [res4h, res24h]);

  return (
    <div className="max-w-6xl mx-auto px-4 py-5">
      <header className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-5 gap-2">
        <div>
          <h1 className="text-xl font-bold text-white tracking-tight"><span className="text-orange-400">BTC</span> Macro Pulse <span className="text-xs font-mono text-gray-600 ml-1">v3.1</span></h1>
          <p className="text-[10px] text-gray-500 mt-0.5 font-mono">Dual-Model Session-Aware Sentiment Engine</p>
        </div>
        <div className="flex items-center gap-3 text-xs font-mono">
          {isDemo&&<span className="px-2 py-0.5 bg-yellow-900/40 text-yellow-500 rounded border border-yellow-800/50 text-[10px]">DEMO</span>}
          {!isDemo&&liveCount>0&&<span className="flex items-center gap-1 px-2 py-0.5 bg-green-900/30 text-green-400 rounded border border-green-800/50 text-[10px]"><span className="w-1.5 h-1.5 bg-green-500 rounded-full live-dot"/>{liveCount} LIVE</span>}
          {lastUpdate&&<span className="text-gray-600 text-[10px]">{lastUpdate.toLocaleTimeString()}</span>}
          <button onClick={load} disabled={loading} className="px-2.5 py-1 bg-terminal-card border border-terminal-border rounded text-gray-400 hover:text-white hover:border-gray-600 transition disabled:opacity-50 text-[10px]">{loading?'...':'Refresh'}</button>
        </div>
      </header>

      {error&&<div className="mb-3 px-3 py-1.5 bg-yellow-900/20 border border-yellow-800/40 rounded text-yellow-500 text-[10px] font-mono">{error}</div>}

      <section className="mb-4"><SessionBar si={si}/></section>

      <section className="bg-terminal-card border border-terminal-border rounded-xl p-5 mb-4">
        <DualScore s4={res4h.score} s24={res24h.score} sum4={sum4h} sum24={sum24h} divExplain={divExplain} loading={loading}/>
      </section>

      <section className="mb-4"><BTCCard btc7d={data?.btc7d} btcBasic={data?.btcBasic}/></section>

      <section className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <SignalPanel title="4h Tactical Momentum" subtitle="Short-term flow" color="#60a5fa" signals={res4h.signals} score={res4h.score}/>
        <SignalPanel title="24h Macro Regime" subtitle="Broader environment" color="#a78bfa" signals={res24h.signals} score={res24h.score}/>
      </section>

      <section className="mb-4"><MethodNote/></section>

      <footer className="text-center text-[10px] text-gray-700 font-mono py-3 border-t border-terminal-border">
        BTC Macro Pulse v3.1 &middot; Dual-model + Funding Rate &middot; Session-aware &middot; Refreshes every 5 min &middot; Not financial advice
      </footer>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
